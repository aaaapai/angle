name: ANGLE

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        arch: ["arm64"]
      fail-fast: false

    name: "Build for Android ${{matrix.arch}}"
    runs-on: ubuntu-latest

    steps:

      - name: Cache depot_tools and dependencies
        uses: actions/cache@main
        with:
          path: |
            depot_tools
            third_party
            .cipd
            .gclient
          key: ${{ runner.os }}-angle-deps-${{ hashFiles('angle/DEPS') }}

      - name: Checkout
        uses: actions/checkout@main
        
      - name: Setup depot_tools
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "DEPOT_TOOLS_COMMIT=$(git -C depot_tools rev-parse HEAD)" >> $GITHUB_ENV
          export PATH=`pwd`/depot_tools:$PATH
          echo $PATH
          python scripts/bootstrap.py

      - name: Run gclient sync
        shell: bash
        run:  |
           echo "DEPOT_TOOLS_COMMIT=$(git -C depot_tools rev-parse HEAD)" >> $GITHUB_ENV
           export PATH=`pwd`/depot_tools:$PATH
           echo $PATH
           gclient sync --no-history --shallow --reset --force
        
      - name: Build ANGLE
        shell: bash
        run: |
          echo "DEPOT_TOOLS_COMMIT=$(git -C depot_tools rev-parse HEAD)" >> $GITHUB_ENV
          export PATH=`pwd`/depot_tools:$PATH
          echo $PATH
          gn gen out/Android-${{matrix.arch}}
          autoninja -C out/Android-${{matrix.arch}} -j $(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@main
        with:
          name: angle-${{matrix.arch}}-${{ github.run_number }}
          path: angle/out/Android-${{matrix.arch}}/*.so
